//the list of the highest peaks in Asia.This object consists
//of the peaks array containing peak's name,position and an empty photos array.
var peaks_list = {
   "peaks": [{
      "name": "Lhotse",
      "position": {
         "lat": 27.9626373,
         "lng": 86.93361499999992
      },
      "photos_array": []
   }, {
      "name": "Kangchenjunga",
      "position": {
         "lat": 27.7024914,
         "lng": 88.14753500000006
      },
      "photos_array": []
   }, {
      "name": "Mount Everest",
      "position": {
         "lat": 27.98785,
         "lng": 86.92502609999997
      },
      "photos_array": []
   }, {
      "name": "Gyachung Kang",
      "position": {
         "lat": 28.098056,
         "lng": 86.74222199999997
      },
      "photos_array": []
   }, {
      "name": "Annapurna",
      "position": {
         "lat": 28.596111,
         "lng": 83.82027800000003
      },
      "photos_array": []
   }, {
      "name": "Nanga Parbat",
      "position": {
         "lat": 35.2375038,
         "lng": 74.58914460000005
      },
      "photos_array": []
   }, {
      "name": "Manaslu",
      "position": {
         "lat": 28.5497107,
         "lng": 84.55967680000003
      },
      "photos_array": []
   }, {
      "name": "Cho Oyu",
      "position": {
         "lat": 28.0972891,
         "lng": 86.65847499999995
      },
      "photos_array": []
   }, {
      "name": "K2",
      "position": {
         "lat": 35.8187277,
         "lng": 76.51371070000005
      },
      "photos_array": []
   }, {
      "name": "Dhaulagiri I",
      "position": {
         "lat": 28.6966666,
         "lng": 83.49416659999997
      },
      "photos_array": []
   }, {
      "name": "Makalu",
      "position": {
         "lat": 27.8860217,
         "lng": 87.09118910000007
      },
      "photos_array": []
   }, {
      "name": "Chomo Lonzo",
      "position": {
         "lat": 27.9308333,
         "lng": 87.10833330000003
      },
      "photos_array": []
   }, {
      "name": "Batura Sar",
      "position": {
         "lat": 36.51,
         "lng": 74.52333329999999
      },
      "photos_array": []
   }, {
      "name": "Kanjut Sar I",
      "position": {
         "lat": 36.2058333,
         "lng": 75.41666659999999
      },
      "photos_array": []
   }, {
      "name": "Saltoro Kangri",
      "position": {
         "lat": 35.3995801,
         "lng": 76.8462968
      },
      "photos_array": []
   }, {
      "name": "Namcha Barwa",
      "position": {
         "lat": 29.6316666,
         "lng": 95.05499989999998
      },
      "photos_array": []
   }, {
      "name": "Tirich Mir",
      "position": {
         "lat": 36.255,
         "lng": 71.8408333
      },
      "photos_array": []
   }, {
      "name": "Kamet",
      "position": {
         "lat": 30.9198246,
         "lng": 79.59028239999998
      },
      "photos_array": []
   }, {
      "name": "Dhaulagiri II",
      "position": {
         "lat": 28.7633333,
         "lng": 83.3883333
      },
      "photos_array": []
   }, {
      "name": "Rakaposhi",
      "position": {
         "lat": 36.1433269,
         "lng": 74.48985679999998
      },
      "photos_array": []
   }, {
      "name": "Kumbhakarna Mountain",
      "position": {
         "lat": 27.6816666,
         "lng": 88.04416659999993
      },
      "photos_array": []
   }, {
      "name": "Gyachung Kang",
      "position": {
         "lat": 28.098056,
         "lng": 86.74222199999997
      },
      "photos_array": []
   }, {
      "name": "Chogolisa",
      "position": {
         "lat": 35.6133333,
         "lng": 76.57500000000005
      },
      "photos_array": []
   }, {
      "name": "Gasherbrum I, Kashgar",
      "position": {
         "lat": 35.7192731,
         "lng": 76.7105636
      },
      "photos_array": []
   }, {
      "name": "Gasherbrum III",
      "position": {
         "lat": 35.7602778,
         "lng": 76.64555559999997
      },
      "photos_array": []
   }, {
      "name": "Dhaulagiri",
      "position": {
         "lat": 28.6984652,
         "lng": 83.48734960000002
      },
      "photos_array": []
   }, {
      "name": "Gurla Mandhata",
      "position": {
         "lat": 30.4,
         "lng": 81.29999999999995
      },
      "photos_array": []
   }, {
      "name": "Broad Peak",
      "position": {
         "lat": 35.8107486,
         "lng": 76.5680122
      },
      "photos_array": []
   }, {
      "name": "Shishapangma",
      "position": {
         "lat": 28.3525,
         "lng": 85.77916660000005
      },
      "photos_array": []
   }, {
      "name": "Saser Kangri",
      "position": {
         "lat": 34.8672222,
         "lng": 77.7511111
      },
      "photos_array": []
   }, {
      "name": "Gasherbrum II",
      "position": {
         "lat": 35.7575,
         "lng": 76.65416660000005
      },
      "photos_array": []
   }, {
      "name": "Gasherbrum III",
      "position": {
         "lat": 35.7602778,
         "lng": 76.64555559999997
      },
      "photos_array": []
   }, {
      "name": "Masherbrum",
      "position": {
         "lat": 35.6420154,
         "lng": 76.30620180000005
      },
      "photos_array": []
   }, {
      "name": "Nuptse",
      "position": {
         "lat": 27.9672192,
         "lng": 86.88553909999996
      },
      "photos_array": []
   }, {
      "name": "Annapurna II",
      "position": {
         "lat": 28.535,
         "lng": 84.12249989999998
      },
      "photos_array": []
   }, {
      "name": "Disteghil Sar",
      "position": {
         "lat": 36.3258333,
         "lng": 75.18833330000007
      },
      "photos_array": []
   }, {
      "name": "Himalchuli",
      "position": {
         "lat": 28.4366666,
         "lng": 84.63999999999999
      },
      "photos_array": []
   }, {
      "name": "Gasherbrum IV",
      "position": {
         "lat": 35.7602778,
         "lng": 76.61694439999997
      },
      "photos_array": []
   }, {
      "name": "Khunyang Chhish",
      "position": {
         "lat": 36.2049642,
         "lng": 75.20652960000007
      },
      "photos_array": []
   }]
};
//function to switch style of the map between dark and bright themes.
function switchTheme() {
   if (!dark) {
      dark = true;
      mapstyle = [{
         "featureType": "all",
         "elementType": "labels.text.fill",
         "stylers": [{
            "saturation": 36
         }, {
            "color": "#000000"
         }, {
            "lightness": 40
         }]
      }, {
         "featureType": "all",
         "elementType": "labels.text.stroke",
         "stylers": [{
            "visibility": "on"
         }, {
            "color": "#000000"
         }, {
            "lightness": 16
         }]
      }, {
         "featureType": "all",
         "elementType": "labels.icon",
         "stylers": [{
            "visibility": "off"
         }]
      }, {
         "featureType": "administrative",
         "elementType": "geometry.fill",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 20
         }]
      }, {
         "featureType": "administrative",
         "elementType": "geometry.stroke",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 17
         }, {
            "weight": 1.2
         }]
      }, {
         "featureType": "landscape",
         "elementType": "geometry",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 20
         }]
      }, {
         "featureType": "poi",
         "elementType": "geometry",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 21
         }]
      }, {
         "featureType": "road.highway",
         "elementType": "geometry.fill",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 17
         }]
      }, {
         "featureType": "road.highway",
         "elementType": "geometry.stroke",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 29
         }, {
            "weight": 0.2
         }]
      }, {
         "featureType": "road.arterial",
         "elementType": "geometry",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 18
         }]
      }, {
         "featureType": "road.local",
         "elementType": "geometry",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 16
         }]
      }, {
         "featureType": "transit",
         "elementType": "geometry",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 19
         }]
      }, {
         "featureType": "water",
         "elementType": "geometry",
         "stylers": [{
            "color": "#000000"
         }, {
            "lightness": 17
         }]
      }];
      map.setOptions({
         styles: mapstyle
      });
   } else {
      dark = false;
      mapstyle = [{
         "featureType": "administrative",
         "elementType": "all",
         "stylers": [{
            "saturation": "-100"
         }]
      }, {
         "featureType": "administrative.province",
         "elementType": "all",
         "stylers": [{
            "visibility": "off"
         }]
      }, {
         "featureType": "landscape",
         "elementType": "all",
         "stylers": [{
            "saturation": -100
         }, {
            "lightness": 65
         }, {
            "visibility": "on"
         }]
      }, {
         "featureType": "poi",
         "elementType": "all",
         "stylers": [{
            "saturation": -100
         }, {
            "lightness": "50"
         }, {
            "visibility": "simplified"
         }]
      }, {
         "featureType": "road",
         "elementType": "all",
         "stylers": [{
            "saturation": "-100"
         }]
      }, {
         "featureType": "road.highway",
         "elementType": "all",
         "stylers": [{
            "visibility": "simplified"
         }]
      }, {
         "featureType": "road.arterial",
         "elementType": "all",
         "stylers": [{
            "lightness": "30"
         }]
      }, {
         "featureType": "road.local",
         "elementType": "all",
         "stylers": [{
            "lightness": "40"
         }]
      }, {
         "featureType": "transit",
         "elementType": "all",
         "stylers": [{
            "saturation": -100
         }, {
            "visibility": "simplified"
         }]
      }, {
         "featureType": "water",
         "elementType": "geometry",
         "stylers": [{
            "hue": "#ffff00"
         }, {
            "lightness": -25
         }, {
            "saturation": -97
         }]
      }, {
         "featureType": "water",
         "elementType": "labels",
         "stylers": [{
            "lightness": -25
         }, {
            "saturation": -100
         }]
      }];
      map.setOptions({
         styles: mapstyle
      });
   }
}
//function to reset the markers and position the map accordingly.
function resetPeaks() {
   for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
   }
   getbounds();
}
//this function is called whenever a peak name is selected from the list
//or the corresponding marker is clicked.
function locateSelected(peakSelected) {
   //hide the side bar once the peak is clicked
   console.log($('#sidebar').hasClass("active"));
   if ($('#sidebar').hasClass("active")) {
      togglesidebar();
   }
   //function to highlight the selected peak from list
   if (peakInfo.marker != peakSelected.marker) {
      peakInfo.close();
   }
   //set the  position of the peak selected as the map center
   //and zoom to the marker .
   map.setCenter(peakSelected.position);
   map.setZoom(9);
   for (var i = 0; i < peaks_list.peaks.length; i++) {
      //to remove animation for previously selected peak.
      peaks_list.peaks[i].marker.setAnimation(null);
   }
   peakSelected.marker.setAnimation(google.maps.Animation.BOUNCE);
   //map.setOptions({ mapTypeId:'hybrid'});
   //object to be passed to the google place search API.
   placeRequest = {
      location: peakSelected.position,
      radius: 5
   };
   //console.log(peakSelected.position);
   //sets the modal name to that of the selected peak.
   $("#ModalLabel").html(peakSelected.name);
   //call the function to get info from the wikipedia,google places and streetview APIs.
   InfofromWiki(peakSelected);
   placeSearch(placeRequest, peakSelected);
   StreetView(peakSelected);
   displayLocationElevation(peakSelected);
}
//this functions makes a request to obtain the wikipedia info on the selected Peak.
function InfofromWiki(location) {
   var wikiurl = "https://en.wikipedia.org/w/api.php?action=opensearch&search=" + location.name + "&format=json&callback=wikiCallback";
   var wikilinks = '';
   var wikilist = '';
   $.ajax(wikiurl, {
      dataType: "jsonp",
      jsonp: "callback",
      success: function(response) {
         console.log(response);
         wikilist = response[1][0];
         wikilinks = response[3][0];
         var wikiinfo = response[2][0];
         peakInfo = new google.maps.InfoWindow({
            Content: '<h3>' + location.name + '</h3><p style="font-size:17px">' +
               wikiinfo + '(<a href=' + wikilinks + '>Click here</a> for more about this place in wiki.).</p><br>' +
               '<button type="button" class="btn  btn-modal" data-toggle="modal" data-target="#myModal">Experience It!</button>'
         });
         peakInfo.open(map, location.marker);
         $(".modal-wiki-info").empty();
         $(".modal-wiki-info").append('<p style="font-size:17px">' +
            wikiinfo + '(<a href=' + wikilinks + '>Click here</a>to read more from wiki.).</p>');
      }
   });
}
//this function first call the place search API and then from the place ID obtained it calls the place details API.
function placeSearch(request, peakSelected) {
   //function to call the place request everytime the infowindow is opened.
   var temp = peakSelected.marker.id;
   var service = new google.maps.places.PlacesService(map);
   service.nearbySearch(request, callback);

   function callback(results, status) {
      //console.log(results);
      //resets the value of the photos_array every time a peak is selected.
      peaks_list.peaks[temp].photos_array = [];
      if (status == google.maps.places.PlacesServiceStatus.OK) {
         //this loop is to request the place details of all the results obtained.
         for (var o = 0; o < results.length; o++) {
            service.getDetails({
               placeId: results[o].place_id
            }, function(place, status) {
               if (status === google.maps.places.PlacesServiceStatus.OK) {
                  for (var i = 0; i < place.photos.length; i++) {
                     peaks_list.peaks[temp].photos_array.push(place.photos[i].getUrl({
                        'maxWidth': 500,
                        'maxHeight': 500
                     }));
                  }
                  //add the appropriate content to the modal.
                  $(".img-badge").html(peaks_list.peaks[temp].photos_array.length);
                  $(".carousel-inner").empty();
                  $(".carousel-inner").append('<div class="item active">' +
                     '<img class="carousel-img" src="icons\\mountain-thumb.jpg" alt="mountain thumbnail" />' +
                     '</div>');
                  $(".carousel-inner").append('<div class="carousel-caption"><h4>' + peakSelected.name + '</h4></div>');
                  //this loop adds the images from obtained form the place details API to the
                  //modal carousel.
                  for (var i = 0; i < peaks_list.peaks[temp].photos_array.length; i++) {
                     var imagelink = peaks_list.peaks[temp].photos_array[i];
                     $(".carousel-inner").append('<div class="item">' +
                        '<img class="carousel-img" src=' + imagelink + ' alt="pic' + i + '"></div>');
                  }
               } else {
                  alert("Something went wrong.No Place details obtained.<br>" + status);
               }
            });
         }
      } else {
         console.log(status);
         $(".carousel-inner").empty();
         $(".carousel-inner").append('<div class="item active">' +
            '<img class="carousel-img" src="icons\\mountain-thumb.jpg" alt="mountain thumbnail" />' +
            '</div>');
         $(".img-badge").html(peaks_list.peaks[temp].photos_array.length);
         $(".carousel-inner").append('sorry,No results were obtained form the google places API for ' + peakSelected.name + ':(<br>Status:<strong>' +
            status + '</strong>');
      }
   }
}
//this function calls the google StreetViewService.
function StreetView(peakSelected) {
   var streetViewService = new google.maps.StreetViewService();
   var radius = 300;
   // In case the status is OK, which means the pano was found, compute the
   // position of the streetview image, then calculate the heading, then get a
   // panorama from that and set the options
   function getStreetView(data, status) {
      if (status == google.maps.StreetViewStatus.OK) {
         var nearStreetViewLocation = data.location.latLng;
         var heading = google.maps.geometry.spherical.computeHeading(
            nearStreetViewLocation, peakSelected.marker.position);
         $('#pano').empty();
         var panoramaOptions = {
            position: nearStreetViewLocation,
            pov: {
               heading: heading,
               pitch: 30
            }
         };
         var panorama = new google.maps.StreetViewPanorama(
            document.getElementById('pano'), panoramaOptions);
      } else {
         $('#pano').empty();
         $('#pano').append('<div>No Street View Found at ' + peakSelected.marker.title +
            '</div><br>status:' + status);
      }
   }
   // Use streetview service to get the closest streetview image within
   // 50 meters of the markers position
   streetViewService.getPanoramaByLocation(peakSelected.position, radius, getStreetView);
   // Open the infowindow on the correct marker.
   //	peakInfo.open(map, peakSelected.marker);
}
//this function calls the ElevationService to get the
//elevation of the peaks.
function displayLocationElevation(peakSelected) {
   var elevator = new google.maps.ElevationService;
   // Initiate the location request
   elevator.getElevationForLocations({
      'locations': [peakSelected.marker.position]
   }, function(results, status) {
      var elev;
      if (status === 'OK') {
         // Retrieve the first result
         if (results[0]) {
            // Open the infowindow indicating the elevation at the clicked position.
            elev = results[0].elevation + 'm';
            $(".modal-peak-Elevation").html("<strong>Elevation</strong>: " + elev);
         } else {
            $(".modal-peak-Elevation").append('No results found');
         }
      } else {
         $(".modal-peak-Elevation").html('Elevation service failed due to: ' + status);
      }
   });
}
// viewmodel
var viewModel = function() {
   this.search = ko.observable("");
   this.place = ko.computed(function() {
      var peaklist = [];
      for (var i = 0; i < peaks_list.peaks.length; i++) {
         peaklist.push(peaks_list.peaks[i]);
      }
      return peaklist;
   });
   //this filters the total list and markers based upon user input
   var i;
   this.peaklist = ko.computed(function() {
      if (this.search().length > 0) {
         var check = [];
         for (i = 0; i < this.place().length; i++) {
            check.push(this.place()[i]);
         }
         var k = this.search();
         var result = [];
         for (i = 0; i < check.length; i++) {
            if (check[i].name.includes(this.search())) {
               result.push(check[i]);
            }
         }
         return result;
      } else {
         return this.place();
      }
   }, this);
};
ko.applyBindings(viewModel);
